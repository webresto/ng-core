import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { EventMessage } from '../services/event-message';
import { throwError } from 'rxjs';
import { tap, catchError } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../services/eventer.service";
import * as i2 from "../services/state.service";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class ServerErrorInterceptor {
    constructor(eventer, state) {
        this.eventer = eventer;
        this.state = state;
    }
    intercept(req, next) {
        console.info('Interceptor', req);
        const authToken = localStorage.getItem(LS_TOKEN_NAME);
        return next.handle(!authToken ? req : req.clone({
            headers: req.headers.set('Authorization', `JWT ${authToken}`)
        })).pipe(tap(event => {
            var _a, _b, _c;
            if (event instanceof HttpResponse && ((_a = event === null || event === void 0 ? void 0 : event.body) === null || _a === void 0 ? void 0 : _a.status) && ((_b = event === null || event === void 0 ? void 0 : event.body) === null || _b === void 0 ? void 0 : _b.message[0])) {
                throw new Error((_c = event === null || event === void 0 ? void 0 : event.body) === null || _c === void 0 ? void 0 : _c.message[0]);
            }
        }), catchError(this.handleError.bind(this)));
    }
    handleError(error) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t;
        if (((_a = error === null || error === void 0 ? void 0 : error.error) === null || _a === void 0 ? void 0 : _a.enable) && typeof ((_b = error === null || error === void 0 ? void 0 : error.error) === null || _b === void 0 ? void 0 : _b.title) !== 'undefined'
            && typeof ((_c = error === null || error === void 0 ? void 0 : error.error) === null || _c === void 0 ? void 0 : _c.description) !== 'undefined'
            && typeof ((_d = error === null || error === void 0 ? void 0 : error.error) === null || _d === void 0 ? void 0 : _d.startDate) !== 'undefined'
            && typeof ((_e = error === null || error === void 0 ? void 0 : error.error) === null || _e === void 0 ? void 0 : _e.stopDate) !== 'undefined') {
            const currentTime = new Date().getTime(), startTime = new Date((_f = error === null || error === void 0 ? void 0 : error.error) === null || _f === void 0 ? void 0 : _f.startDate).getTime(), stopTime = new Date((_g = error === null || error === void 0 ? void 0 : error.error) === null || _g === void 0 ? void 0 : _g.stopDate).getTime();
            if (currentTime > startTime && currentTime < stopTime) {
                this.state.maintenance$.next({
                    title: error.error.title,
                    description: error.error.description,
                    social: error.error.social
                });
            }
            ;
            return throwError(error.error);
        }
        ;
        switch (true) {
            case (error === null || error === void 0 ? void 0 : error.error) instanceof ErrorEvent:
                console.error('An error occurred:', (_h = error === null || error === void 0 ? void 0 : error.error) === null || _h === void 0 ? void 0 : _h.message);
                return throwError(error === null || error === void 0 ? void 0 : error.error);
                ;
            case (error instanceof Error && (error === null || error === void 0 ? void 0 : error.message) == 'timeout-or-duplicate'):
                console.error('An error occurred:', error === null || error === void 0 ? void 0 : error.message);
                return throwError('Ошибка сервера (таймаут). Повторите попытку позже');
            case (error instanceof Error && (error === null || error === void 0 ? void 0 : error.message) != 'timeout-or-duplicate'):
                console.error(`Backend returned code ${error === null || error === void 0 ? void 0 : error.status}, ` + `body was: ${error === null || error === void 0 ? void 0 : error.error}`);
                if ((error === null || error === void 0 ? void 0 : error.status) == 401) {
                    this.eventer.emitMessageEvent(new EventMessage('Unauthorized', '', ''));
                    localStorage.removeItem(LS_TOKEN_NAME);
                    return throwError(((_j = error === null || error === void 0 ? void 0 : error.error) === null || _j === void 0 ? void 0 : _j.title) ? (_k = error === null || error === void 0 ? void 0 : error.error) === null || _k === void 0 ? void 0 : _k.title : 'Необходимо пройти авторизацию');
                }
                else if ((error === null || error === void 0 ? void 0 : error.status) == 404 && (error === null || error === void 0 ? void 0 : error.error) == "User not found") {
                    localStorage.removeItem(LS_TOKEN_NAME);
                }
                else if (((error === null || error === void 0 ? void 0 : error.status) == 400 || (error === null || error === void 0 ? void 0 : error.status) == 500)
                    && ((_m = (_l = error === null || error === void 0 ? void 0 : error.error) === null || _l === void 0 ? void 0 : _l.message) === null || _m === void 0 ? void 0 : _m.title)
                    && ((_p = (_o = error === null || error === void 0 ? void 0 : error.error) === null || _o === void 0 ? void 0 : _o.message) === null || _p === void 0 ? void 0 : _p.body)) {
                    this.eventer.emitMessageEvent(new EventMessage('error', (_r = (_q = error === null || error === void 0 ? void 0 : error.error) === null || _q === void 0 ? void 0 : _q.message) === null || _r === void 0 ? void 0 : _r.title, (_t = (_s = error === null || error === void 0 ? void 0 : error.error) === null || _s === void 0 ? void 0 : _s.message) === null || _t === void 0 ? void 0 : _t.body));
                }
                return throwError(error === null || error === void 0 ? void 0 : error.error);
        }
        ;
        // return an observable with a user-facing error message
    }
    ;
}
ServerErrorInterceptor.ɵfac = function ServerErrorInterceptor_Factory(t) { return new (t || ServerErrorInterceptor)(i0.ɵɵinject(i1.EventerService), i0.ɵɵinject(i2.StateService)); };
ServerErrorInterceptor.ɵprov = i0.ɵɵdefineInjectable({ token: ServerErrorInterceptor, factory: ServerErrorInterceptor.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(ServerErrorInterceptor, [{
        type: Injectable
    }], function () { return [{ type: i1.EventerService }, { type: i2.StateService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLWVycm9yLmludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9odHRwLWludGVyY2VwdG9ycy9zZXJ2ZXItZXJyb3IuaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBS0wsWUFBWSxFQUViLE1BQU0sc0JBQXNCLENBQUM7QUFHOUIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXpELE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUdqRCxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUM7QUFHbEMsTUFBTSxPQUFPLHNCQUFzQjtJQUVqQyxZQUNVLE9BQXVCLEVBQ3ZCLEtBQW1CO1FBRG5CLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLFVBQUssR0FBTCxLQUFLLENBQWM7SUFDekIsQ0FBQztJQUVMLFNBQVMsQ0FBQyxHQUFxQixFQUFFLElBQWlCO1FBQ2hELE9BQU8sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDOUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxPQUFPLFNBQVMsRUFBRSxDQUFDO1NBQzlELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDTixHQUFHLENBQ0QsS0FBSyxDQUFDLEVB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LGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsS0FBSywwQ0FBRSxPQUFPLDBDQUFFLEtBQUssQ0FBQTtvQ0FDNUIsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEtBQUssMENBQUUsT0FBTywwQ0FBRSxJQUFJLENBQUEsRUFBRTtvQkFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FDM0IsSUFBSSxZQUFZLENBQUMsT0FBTyxjQUFFLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxLQUFLLDBDQUFFLE9BQU8sMENBQUUsS0FBSyxjQUFFLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxLQUFLLDBDQUFFLE9BQU8sMENBQUUsSUFBSSxDQUFDLENBQ3JGLENBQUM7aUJBQ0g7Z0JBQ0QsT0FBTyxVQUFVLENBQUMsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ25DO1FBQUEsQ0FBQztRQUNGLHdEQUF3RDtJQUMxRCxDQUFDO0lBQUEsQ0FBQzs7NEZBekVTLHNCQUFzQjs4REFBdEIsc0JBQXNCLFdBQXRCLHNCQUFzQjtrREFBdEIsc0JBQXNCO2NBRGxDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgSHR0cEV2ZW50LFxyXG4gIEh0dHBJbnRlcmNlcHRvcixcclxuICBIdHRwSGFuZGxlcixcclxuICBIdHRwUmVxdWVzdCxcclxuICBIdHRwUmVzcG9uc2UsXHJcbiAgSHR0cEVycm9yUmVzcG9uc2VcclxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBFdmVudGVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2V2ZW50ZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IEV2ZW50TWVzc2FnZSB9IGZyb20gJy4uL3NlcnZpY2VzL2V2ZW50LW1lc3NhZ2UnO1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9zdGF0ZS5zZXJ2aWNlXCI7XHJcblxyXG5jb25zdCBMU19UT0tFTl9OQU1FID0gJ2dmOnRrbjp2Mic7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTZXJ2ZXJFcnJvckludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGV2ZW50ZXI6IEV2ZW50ZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBzdGF0ZTogU3RhdGVTZXJ2aWNlXHJcbiAgKSB7IH1cclxuXHJcbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XHJcbiAgICBjb25zb2xlLmluZm8oJ0ludGVyY2VwdG9yJywgcmVxKTtcclxuICAgIGNvbnN0IGF1dGhUb2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExTX1RPS0VOX05BTUUpO1xyXG4gICAgcmV0dXJuIG5leHQuaGFuZGxlKCFhdXRoVG9rZW4gPyByZXEgOiByZXEuY2xvbmUoe1xyXG4gICAgICBoZWFkZXJzOiByZXEuaGVhZGVycy5zZXQoJ0F1dGhvcml6YXRpb24nLCBgSldUICR7YXV0aFRva2VufWApXHJcbiAgICB9KSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIGV2ZW50ID0+IHtcclxuICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSAmJiBldmVudD8uYm9keT8uc3RhdHVzICYmIGV2ZW50Py5ib2R5Py5tZXNzYWdlWzBdKSB7XHJcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGV2ZW50Py5ib2R5Py5tZXNzYWdlWzBdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICksXHJcbiAgICAgIGNhdGNoRXJyb3IodGhpcy5oYW5kbGVFcnJvci5iaW5kKHRoaXMpKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XHJcbiAgICBpZiAoZXJyb3I/LmVycm9yPy5lbmFibGVcclxuICAgICAgJiYgdHlwZW9mIGVycm9yPy5lcnJvcj8udGl0bGUgIT09ICd1bmRlZmluZWQnXHJcbiAgICAgICYmIHR5cGVvZiBlcnJvcj8uZXJyb3I/LmRlc2NyaXB0aW9uICE9PSAndW5kZWZpbmVkJ1xyXG4gICAgICAmJiB0eXBlb2YgZXJyb3I/LmVycm9yPy5zdGFydERhdGUgIT09ICd1bmRlZmluZWQnXHJcbiAgICAgICYmIHR5cGVvZiBlcnJvcj8uZXJyb3I/LnN0b3BEYXRlICE9PSAndW5kZWZpbmVkJykge1xyXG5cclxuICAgICAgY29uc3QgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSxcclxuICAgICAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZShlcnJvcj8uZXJyb3I/LnN0YXJ0RGF0ZSkuZ2V0VGltZSgpLFxyXG4gICAgICAgIHN0b3BUaW1lID0gbmV3IERhdGUoZXJyb3I/LmVycm9yPy5zdG9wRGF0ZSkuZ2V0VGltZSgpO1xyXG5cclxuICAgICAgaWYgKGN1cnJlbnRUaW1lID4gc3RhcnRUaW1lICYmIGN1cnJlbnRUaW1lIDwgc3RvcFRpbWUpIHtcclxuICAgICAgICB0aGlzLnN0YXRlLm1haW50ZW5hbmNlJC5uZXh0KHtcclxuICAgICAgICAgIHRpdGxlOiBlcnJvci5lcnJvci50aXRsZSxcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBlcnJvci5lcnJvci5kZXNjcmlwdGlvbixcclxuICAgICAgICAgIHNvY2lhbDogZXJyb3IuZXJyb3Iuc29jaWFsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvci5lcnJvcik7XHJcbiAgICB9O1xyXG4gICAgc3dpdGNoICh0cnVlKSB7XHJcbiAgICAgIGNhc2UgZXJyb3I/LmVycm9yIGluc3RhbmNlb2YgRXJyb3JFdmVudDogY29uc29sZS5lcnJvcignQW4gZXJyb3Igb2NjdXJyZWQ6JywgZXJyb3I/LmVycm9yPy5tZXNzYWdlKTsgcmV0dXJuIHRocm93RXJyb3IoZXJyb3I/LmVycm9yKTs7XHJcbiAgICAgIGNhc2UgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3I/Lm1lc3NhZ2UgPT0gJ3RpbWVvdXQtb3ItZHVwbGljYXRlJyk6XHJcbiAgICAgICAgY29uc29sZS5lcnJvcignQW4gZXJyb3Igb2NjdXJyZWQ6JywgZXJyb3I/Lm1lc3NhZ2UpO1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCfQntGI0LjQsdC60LAg0YHQtdGA0LLQtdGA0LAgKNGC0LDQudC80LDRg9GCKS4g0J/QvtCy0YLQvtGA0LjRgtC1INC/0L7Qv9GL0YLQutGDINC/0L7Qt9C20LUnKTtcclxuICAgICAgY2FzZSAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvcj8ubWVzc2FnZSAhPSAndGltZW91dC1vci1kdXBsaWNhdGUnKTpcclxuICAgICAgICBjb25zb2xlLmVycm9yKFxyXG4gICAgICAgICAgYEJhY2tlbmQgcmV0dXJuZWQgY29kZSAke2Vycm9yPy5zdGF0dXN9LCBgICsgYGJvZHkgd2FzOiAke2Vycm9yPy5lcnJvcn1gKTtcclxuICAgICAgICBpZiAoZXJyb3I/LnN0YXR1cyA9PSA0MDEpIHtcclxuICAgICAgICAgIHRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdVbmF1dGhvcml6ZWQnLCAnJywgJycpXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oTFNfVE9LRU5fTkFNRSk7XHJcbiAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihcclxuICAgICAgICAgICAgZXJyb3I/LmVycm9yPy50aXRsZSA/IGVycm9yPy5lcnJvcj8udGl0bGUgOiAn0J3QtdC+0LHRhdC+0LTQuNC80L4g0L/RgNC+0LnRgtC4INCw0LLRgtC+0YDQuNC30LDRhtC40Y4nXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZXJyb3I/LnN0YXR1cyA9PSA0MDQgJiYgZXJyb3I/LmVycm9yID09IFwiVXNlciBub3QgZm91bmRcIikge1xyXG4gICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oTFNfVE9LRU5fTkFNRSk7XHJcbiAgICAgICAgfSBlbHNlIGlmICgoZXJyb3I/LnN0YXR1cyA9PSA0MDAgfHwgZXJyb3I/LnN0YXR1cyA9PSA1MDApXHJcbiAgICAgICAgICAmJiBlcnJvcj8uZXJyb3I/Lm1lc3NhZ2U/LnRpdGxlXHJcbiAgICAgICAgICAmJiBlcnJvcj8uZXJyb3I/Lm1lc3NhZ2U/LmJvZHkpIHtcclxuICAgICAgICAgIHRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdlcnJvcicsIGVycm9yPy5lcnJvcj8ubWVzc2FnZT8udGl0bGUsIGVycm9yPy5lcnJvcj8ubWVzc2FnZT8uYm9keSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yPy5lcnJvcik7XHJcbiAgICB9O1xyXG4gICAgLy8gcmV0dXJuIGFuIG9ic2VydmFibGUgd2l0aCBhIHVzZXItZmFjaW5nIGVycm9yIG1lc3NhZ2VcclxuICB9O1xyXG59Il19